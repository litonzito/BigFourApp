@model CreateEventVM
@{
    var formAction = ViewData["FormAction"]?.ToString() ?? "CreateEvent";
    var submitLabel = ViewData["SubmitLabel"]?.ToString() ?? "Guardar";
    var formTitle = ViewData["FormTitle"]?.ToString() ?? "Gestionar evento";
    var formSubtitle = ViewData["FormSubtitle"]?.ToString() ?? "Completa la información del evento.";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">@formTitle</h1>
            <p class="text-muted mb-0">@formSubtitle</p>
        </div>
        <a asp-action="EventDashboard" class="btn btn-outline-secondary">Volver al dashboard</a>
    </div>

    <form asp-action="@formAction" method="post" enctype="multipart/form-data" class="card shadow-sm mb-4">
        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="ExistingSeatmapUrl" />

        @for (var i = 0; i < Model.ExistingImages.Count; i++)
        {
            <input type="hidden" name="ExistingImages[@i]" value="@Model.ExistingImages[i]" />
        }

        <div class="card-body">
            <div class="mb-4">
                <h2 class="h5">Información general</h2>
                <p class="text-muted small mb-0">Los campos marcados con <span class="text-danger">*</span> son obligatorios.</p>
            </div>

            <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="Name" class="form-label"></label><span class="text-danger ms-1">*</span>
                    <input asp-for="Name" class="form-control" />
                    <span asp-validation-for="Name" class="text-danger"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="Url" class="form-label"></label>
                    <input asp-for="Url" class="form-control" />
                    <span asp-validation-for="Url" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="EventDateText" class="form-label"></label><span class="text-danger ms-1">*</span>
                    <input asp-for="EventDateText" type="date" class="form-control" />
                    <span asp-validation-for="EventDateText" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="EventTimeText" class="form-label">Hora del evento</label><span class="text-danger ms-1">*</span>
                    <input asp-for="EventTimeText" type="time" class="form-control" />
                    <span asp-validation-for="EventTimeText" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="Segment" class="form-label"></label>
                    <input asp-for="Segment" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label asp-for="Genre" class="form-label"></label>
                    <input asp-for="Genre" class="form-control" />
                </div>
            </div>

            <div class="row g-3 mt-0">
                <div class="col-md-4">
                    <label asp-for="SubGenre" class="form-label"></label>
                    <input asp-for="SubGenre" class="form-control" />
                </div>
                <div class="col-md-4 d-flex align-items-center">
                    <div class="form-check me-3">
                        <input asp-for="SafeTix" class="form-check-input" />
                        <label asp-for="SafeTix" class="form-check-label"></label>
                    </div>
                    <div class="form-check">
                        <input asp-for="IsCancelled" class="form-check-input" />
                        <label asp-for="IsCancelled" class="form-check-label"></label>
                    </div>
                </div>
            </div>

            <hr class="my-4" />

            <div class="mb-3">
                <h2 class="h5">Ubicación</h2>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="VenueName" class="form-label"></label><span class="text-danger">*</span>
                    <input asp-for="VenueName" class="form-control" />
                    <span asp-validation-for="VenueName" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="City" class="form-label"></label><span class="text-danger">*</span>
                    <input asp-for="City" class="form-control" />
                    <span asp-validation-for="City" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="State" class="form-label"></label><span class="text-danger">*</span>
                    <input asp-for="State" class="form-control" />
                    <span asp-validation-for="State" class="text-danger"></span>
                </div>
            </div>

            <hr class="my-4" />

            <div class="mb-3">
                <h2 class="h5">Recursos multimedia</h2>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="SeatmapImage" class="form-label">Mapa de asientos</label>
                    <input asp-for="SeatmapImage" type="file" accept="image/*" class="form-control" id="SeatmapImage" />
                    <div class="form-text">Formatos permitidos: JPG, PNG.</div>

                    <div id="seatmapPreview" class="mt-3" style="@(string.IsNullOrEmpty(Model.ExistingSeatmapUrl) ? "display:none;" : "")">
                        <p class="text-muted small mb-2">Vista previa</p>
                        <img src="@Model.ExistingSeatmapUrl" alt="Seatmap" class="img-fluid rounded border" />
                    </div>
                </div>
                <div class="col-md-6">
                    <label asp-for="EventImages" class="form-label">Imágenes del evento</label>
                    <input asp-for="EventImages" type="file" multiple accept="image/*" class="form-control" id="EventImages" />
                    <div class="form-text">Puedes seleccionar varias imágenes.</div>

                    <div id="imagePreviewContainer" class="mt-3" style="display:none;">
                        <p class="text-muted small mb-2">Nuevas imágenes</p>
                        <div id="imagePreviewList" class="row g-2"></div>
                    </div>

                    @if (Model.ExistingImages?.Any() == true)
                    {
                        <div class="mt-3">
                            <p class="text-muted small mb-2">Imágenes actuales</p>
                            <div class="row g-2">
                                @foreach (var url in Model.ExistingImages)
                                {
                                    <div class="col-6 col-md-4">
                                        <div class="border rounded p-2 h-100 text-center">
                                            <img src="@url" class="img-fluid rounded mb-2" alt="Evento" />
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="ImagesToRemove" value="@url" id="remove_@url.GetHashCode()">
                                                <label class="form-check-label" for="remove_@url.GetHashCode()">Eliminar</label>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <hr class="my-4" />

            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h2 class="h5 mb-1">Secciones</h2>
                    <p class="text-muted small mb-0">Configura las secciones y su capacidad.</p>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="addSectionBtn">Agregar sección</button>
            </div>

            <div id="sectionsContainer">
                @{
                    System.Collections.Generic.IList<SectionInputVM> sections = Model.Sections?.Any() == true
                        ? Model.Sections
                        : new System.Collections.Generic.List<SectionInputVM>
                        {
                            new SectionInputVM { DisplayName = "General", SeatCount = 100, SeatsPerRow = 10, BasePrice = 85 }
                        };
                }

                @for (var i = 0; i < sections.Count; i++)
                {
                    var sec = sections[i];
                    <div class="border rounded-3 p-3 mb-3 section-block" data-index="@i">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label" data-field="DisplayName" for="Sections_@(i)__DisplayName">Nombre *</label>
                                <input class="form-control" data-field="DisplayName" name="Sections[@i].DisplayName" id="Sections_@(i)__DisplayName" value="@sec.DisplayName" required />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" data-field="SeatCount" for="Sections_@(i)__SeatCount">Asientos *</label>
                                <input class="form-control" data-field="SeatCount" type="number" name="Sections[@i].SeatCount" id="Sections_@(i)__SeatCount" value="@sec.SeatCount" min="1" required />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" data-field="SeatsPerRow" for="Sections_@(i)__SeatsPerRow">Por fila *</label>
                                <input class="form-control" data-field="SeatsPerRow" type="number" name="Sections[@i].SeatsPerRow" id="Sections_@(i)__SeatsPerRow" value="@sec.SeatsPerRow" min="1" required />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" data-field="BasePrice" for="Sections_@(i)__BasePrice">Precio *</label>
                                <input class="form-control" data-field="BasePrice" type="number" step="0.01" name="Sections[@i].BasePrice" id="Sections_@(i)__BasePrice" value="@sec.BasePrice" min="1" required />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label" data-field="SectionCode" for="Sections_@(i)__SectionCode">Código</label>
                                <input class="form-control" data-field="SectionCode" name="Sections[@i].SectionCode" id="Sections_@(i)__SectionCode" value="@sec.SectionCode" />
                            </div>
                        </div>
                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-outline-danger btn-sm remove-section-btn @(sections.Count == 1 ? "disabled" : string.Empty)">Eliminar sección</button>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="card-footer text-end">
            <button type="submit" class="btn btn-primary">@submitLabel</button>
        </div>
    </form>
</div>

<template id="sectionTemplate">
    <div class="border rounded-3 p-3 mb-3 section-block" data-index="__index__">
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label" data-field="DisplayName" for="Sections___index__DisplayName">Nombre *</label>
                <input class="form-control" data-field="DisplayName" name="Sections[__index__].DisplayName" id="Sections___index__DisplayName" required />
            </div>
            <div class="col-md-2">
                <label class="form-label" data-field="SeatCount" for="Sections___index__SeatCount">Asientos *</label>
                <input class="form-control" data-field="SeatCount" type="number" name="Sections[__index__].SeatCount" id="Sections___index__SeatCount" value="50" min="1" required />
            </div>
            <div class="col-md-2">
                <label class="form-label" data-field="SeatsPerRow" for="Sections___index__SeatsPerRow">Por fila *</label>
                <input class="form-control" data-field="SeatsPerRow" type="number" name="Sections[__index__].SeatsPerRow" id="Sections___index__SeatsPerRow" value="10" min="1" required />
            </div>
            <div class="col-md-2">
                <label class="form-label" data-field="BasePrice" for="Sections___index__BasePrice">Precio *</label>
                <input class="form-control" data-field="BasePrice" type="number" step="0.01" name="Sections[__index__].BasePrice" id="Sections___index__BasePrice" value="85" min="1" required />
            </div>
            <div class="col-md-2">
                <label class="form-label" data-field="SectionCode" for="Sections___index__SectionCode">Código</label>
                <input class="form-control" data-field="SectionCode" name="Sections[__index__].SectionCode" id="Sections___index__SectionCode" />
            </div>
        </div>
        <div class="text-end mt-3">
            <button type="button" class="btn btn-outline-danger btn-sm remove-section-btn">Eliminar sección</button>
        </div>
    </div>
</template>

@section Scripts {
    <script src="~/js/manager-event-form.js" asp-append-version="true"></script>
}
